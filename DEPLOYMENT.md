# 🚀 Vercel部署指南

## 问题诊断

你遇到的错误 `"Request En"... is not valid JSON` 通常是由以下原因导致的：

1. **请求体过大**：Vercel有4.5MB的请求体限制
2. **响应超时**：API处理时间过长
3. **内存限制**：处理大文件时内存不足

## 解决方案

### 1. 文件大小限制
- ✅ 设置最大文件大小为9MB（平衡性能和用户需求）
- ✅ 添加了请求体大小检查
- ✅ 改进了错误处理

### 2. Vercel配置
- ✅ 创建了 `vercel.json` 配置文件
- ✅ 设置了API函数超时时间为60秒
- ✅ 配置了亚洲区域部署

### 3. Next.js配置
- ✅ 更新了 `next.config.js`
- ✅ 添加了API路由配置
- ✅ 设置了外部包配置

## 部署步骤

### 1. 推送代码到Git仓库
```bash
git add .
git commit -m "fix: 修复Vercel部署问题，降低文件大小限制"
git push origin main
```

### 2. 在Vercel中重新部署
1. 登录 [Vercel Dashboard](https://vercel.com/dashboard)
2. 找到你的项目
3. 点击 "Redeploy" 按钮
4. 选择最新的commit进行部署

### 3. 环境变量配置（可选）
如果需要使用数据库或AI功能，在Vercel项目设置中添加环境变量：
- `NEXT_PUBLIC_SUPABASE_URL`
- `NEXT_PUBLIC_SUPABASE_ANON_KEY`
- `OPENAI_API_KEY`

## 测试建议

部署完成后，请测试以下场景：

1. **小文件上传**（< 1MB）
   - 测试PDF、DOCX、TXT文件
   - 确认思维导图正常生成

2. **中等文件上传**（3-6MB）
   - 测试处理时间
   - 确认没有超时错误

3. **大文件上传**（6-9MB）
   - 测试边界情况
   - 确认错误提示友好

4. **文本输入**
   - 测试长文本处理
   - 确认响应速度

## 监控和调试

### 查看部署日志
1. 在Vercel Dashboard中点击部署记录
2. 查看 "Functions" 标签页
3. 检查API函数的执行日志

### 常见错误处理
- **413 Payload Too Large**：文件过大，已添加前端验证
- **504 Gateway Timeout**：处理超时，已设置60秒限制
- **500 Internal Server Error**：服务器错误，检查函数日志

## 性能优化建议

1. **文件处理优化**
   - 对大文件进行分块处理
   - 添加进度条显示
   - 实现文件压缩

2. **缓存策略**
   - 缓存解析结果
   - 使用CDN加速静态资源

3. **错误恢复**
   - 添加重试机制
   - 提供降级方案

## 故障排除

如果部署后仍有问题：

1. **检查Vercel函数日志**
2. **验证文件大小限制**
3. **测试API端点响应**
4. **检查网络连接**

联系支持：如果问题持续存在，请提供具体的错误信息和复现步骤。
